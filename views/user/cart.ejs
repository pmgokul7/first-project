<%-include("../partials/top")%>

<%-include("../partials/userHeader.ejs")%>
<style>
	#coupon-success{
  color: #4BB543;
  margin-top: 3px;
  margin-bottom: 3px;
  visibility: hidden;
}
#codeinput2{
  
  border: 1px solid rgba(173, 167, 167, 0.603);
  outline: none;
  width: 100px;
  text-align: center;
  margin-right: 3px;
}
  #codetext{
    width: 300px;
    padding: 10px;
  }
</style>
		<div class="container">
		<table class="table  mt-5
		">
			<thead>
			  <tr>
				<th scope="col">#</th>
				<th scope="col">.</th>
				<th scope="col">Model</th>
				<th scope="col">Price</th>
				<th scope="col">Quantity</th>
				<th scope="col">Total</th>
			  </tr>
			</thead>
			<tbody>
				<%for(i=0;i<=result.length-1;i++){%>
			  <tr>
				<th scope="row"><%=i+1%></th>
				<td><img src="<%=result[i].pro.mainImage%>" width="100px" alt=""></td>
				<td><%=result[i].pro.model%></td>
				<td class="g"><%=result[i].pro.offerprice%></td>
				
				<td>
					
					<button class="cart-item-count me-2 btn btn-info" onclick="changeQuantity('<%=result[i]._id%>','<%=result[i].pro._id%>',-1,'<%=result[i].pro._id%>a','<%=result[i].pro.offerprice%>','<%=result[i].products.count%>','<%=result[i].pro._id%>A')" id='<%=result[i].pro._id%>A' >-</button>
					
					<span id="<%=result[i].pro._id%>"><%=result[i].products.count%></span>
					<button class="cart-item-count ms-2 btn btn-info" onclick="changeQuantity('<%=result[i]._id%>','<%=result[i].pro._id%>',1,'<%=result[i].pro._id%>a','<%=result[i].pro.offerprice%>','<%=result[i].products.count%>','<%=result[i].pro._id%>A')" id='<%=result[i].pro._id%>B' >+</button>
				</td>
				<td id="<%=result[i].pro._id%>a">₹<%=result[i].pro.offerprice * result[i].products.count%></td>
				<td>
					<a href="/home/removeFromCart/<%=result[i].products.product%>" class="btn btn-danger">remove</a>
				</td>
			  </tr>
			  <%}%>	
			 
			</tbody>
		  </table>
		  <hr>
		  <%if(result.length!=0){%>
		  <div class="checkoutdiv float-end me-5 mt-5">
			
			Grand Total:₹<h1 id="totalp"></h1>
			
			<a href="/home/cart/checkout" >
				
			<button class="checkout btn-lg btn-success" style="height:50px ;padding: 5px 10px 5px 10px;">proceed to checkout</button>
			</a>
		  </div>
		  <%}%>
		</div>
		 
		

		</div>
	</main>


	<script>
		function applybtn(){
  const codevalue=$("#codeinput2").val()
  $.post("/home/couponcheck",{
    code:codevalue
  },(res)=>{
	console.log(res);
    couponresponse=res.result.discount
    couponcode=res.result.ID
    if(res.couponFound==true){
		$("#totalp").text(Math.ceil(($("#totalp").text())-parseInt($("#totalp").text())*parseInt(res.result.discount)/100))
        $(".g").text($(".g").text())
      $("#codeinput2").css("border","2px solid #4BB543")
      $("#coupon-success").css("visibility","visible")
      $("#price").html(Number($("#price").html())-Number($("#price").html()*Number(res.result.discount)/100));
      $("#applyBtn").prop("disabled",true)
    }
    else if(res.couponFound==false){
      
      $("#codeinput2").css("border","2px solid red")

    }
    
  })
}
		function changeQuantity(cartId,proId,count,carta,price,quantity,btnid){
			
			quantity=parseInt($(`#${proId}`).text())
			
			
             $.post("/home/changeQuantity",{
                cart:cartId,
				product:proId,
				count:count,
				quantity:quantity,
		

			 },(response)=>{
				if(response){
					
					$(`#${proId}`).text(quantity+parseInt(count	))
					$.post("/home/gettotal",{data:"hai"},(res)=>{
				// console.log(res[0].total);
				if(res)
				{
					$("#totalp").html(`₹${res.total}`)
				}
				
			})
					
					$(`#${carta}`).text(parseInt($(`#${proId}`).text()*parseInt(price)))
					if(quantity+parseInt(count)==1){
						$(`#${btnid}`).prop("disabled", true)
                      
					}else{
						$(`#${btnid}`).prop("disabled", false)
					}
				}
			 })
		
			 
		}

		$(document).ready(()=>{
			

			$.post("/home/gettotal",{data:"hai"},(res)=>{
			    console.log("kjhgfghjkl",res);
				if(res)
				{
					$("#totalp").html(`${res.total}`)
				}
				
			})
		})
	</script>

  </div>